Imports System
Imports System.Net.Http
Imports System.Net.Http.Headers
Imports System.Text
Imports System.Threading.Tasks

Imports System
Imports System.Net.Http
Imports System.Net.Http.Headers
Imports System.Text
Imports System.Threading.Tasks

Public Class ApiClient
    Private Shared ReadOnly client As New HttpClient()

    Public Function CallApiMethod(url As String, token As String, bodyContent As String) As Task(Of String)
        Dim tcs As New TaskCompletionSource(Of String)()

        client.DefaultRequestHeaders.Authorization = New AuthenticationHeaderValue("Bearer", token)

        Dim content = New StringContent(bodyContent, Encoding.UTF8, "application/json")
        client.PostAsync(url, content).ContinueWith(Sub(responseTask As Task(Of HttpResponseMessage))
                                                        Dim response = responseTask.Result
                                                        If response.IsSuccessStatusCode Then
                                                            response.Content.ReadAsStringAsync().ContinueWith(Sub(readTask As Task(Of String))
                                                                                                                  tcs.SetResult(readTask.Result)
                                                                                                              End Sub)
                                                        Else
                                                            tcs.SetException(New Exception("API request failed"))
                                                        End If
                                                    End Sub)

        Return tcs.Task
    End Function
End Class



Sub Main()
    Dim apiClient = New ApiClient()
    Dim apiUrl As String = "https://example.com/api/resource"
    Dim token As String = "your_token_here"
    Dim bodyContent As String = "{""key"": ""value""}"

    ' Consumir la API usando el token
    apiClient.CallApiMethod(apiUrl, token, bodyContent).ContinueWith(AddressOf OnApiMethodCalled)
End Sub

Sub OnApiMethodCalled(responseTask As Task(Of String))
    If responseTask.IsCompleted AndAlso Not responseTask.IsFaulted Then
        Dim response = responseTask.Result
        Console.WriteLine(response)
    Else
        Console.WriteLine("API request failed: " & responseTask.Exception.Message)
    End If
End Sub
